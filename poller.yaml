functions:
- id: nutanix
  image: gcr.io/direktiv/functions/nutanix:1.0
  type: knative-workflow

states:

- id: get-check-time
  type: getter
  variables:
  - key: lastcheck
    scope: workflow
  transform:
    # set time to 0 if it does not exist
    time: jq(if (.var.lastcheck > 0) then .var.lastcheck else 0 end)
  transition: set-check-time
  
# set save time for next run
- id: set-check-time
  type: setter
  variables:
  - key: lastcheck
    scope: workflow
    value: jq(now * 1000000000)
  transition: token

# changes the IP from old to new
# it fails automatically after 30 seconds 
# because the connection is broken after changing the IP
- id: token 
  type: action
  log: fetching move token
  action:
    function: nutanix
    secrets: ["movepwd"]
    input: 
      auth:
        host: https://10.32.160.40
        skipVerify: true
      api:
        path: "/move/v2/users/login"
        method: POST
        body: 
          Spec:
            UserName: nutanix
            Password: jq(.secrets.movepwd)
  transform:
    token: jq(.return.nutanix.Status.Token)
    time: jq(.time)
  transition: fetch-events

- id: fetch-events 
  type: action
  log: fetching move events with token jq(.token)
  action:
    function: nutanix
    input: 
      auth:
        host: https://10.32.160.40
        skipVerify: true
        token: jq(.token)
      api:
        path: "/move/v2/events"
        method: POST
        body: 
          Filter:
            EventNames:
            - Initiate Cutover
            EventStatus:
            - Completed
          PaginationCriteria:
            PageNumber: 1
            RecordsPerPage: 100
  transform:  
    events: jq(.return.nutanix.Events)
    time: jq(.time)
 

# .return.nutanix.Events.[] | select(.EndTime > 166396186044132100)